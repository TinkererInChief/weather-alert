# âœ… Enterprise Audit Logging - Deployment Checklist

## What We've Implemented

### 1. Unified Audit Logging
- âœ… Single `logAudit()` function in `lib/rbac.ts`
- âœ… Auto-captures: `ipAddress`, `userAgent`, `requestId`, `method`, `path`
- âœ… Migrated all routes to use unified logger
- âœ… Removed duplicate `logAudit()` in `lib/rbac/authorization.ts`

### 2. Request Context Propagation
- âœ… `middleware.ts` injects `x-request-id`, `x-method`, `x-path` headers
- âœ… Headers mirrored on response for tracing
- âœ… Auto-captured by `logAudit()` via `next/headers`

### 3. Database Schema
- âœ… Extended `AuditLog` model with enterprise fields:
  - `eventId` (UUID, unique, nullable)
  - `requestId`, `method`, `path` (request context)
  - `organizationId`, `actorRole`, `actorEmail` (actor context)
  - `sessionId`, `traceId` (session tracking)
  - `httpStatus`, `success`, `severity`, `category` (classification)
  - `service`, `env`, `version` (deployment context)
- âœ… Added performance indexes on key columns
- âœ… Schema synced to Railway Postgres

### 4. Railway Deployment
- âœ… `.env` configured with Railway DATABASE_URL
- âœ… `package.json` has `start:railway` script
- âœ… Script runs `prisma db push` before server start

---

## Railway Configuration Steps

### Step 1: Set Start Command
1. Go to **Railway Dashboard**
2. Select your project
3. Click on your **web service**
4. Go to **Settings** â†’ **Deploy**
5. Find **"Start Command"**
6. Set to: `pnpm run start:railway`
7. Click **Save**

### Step 2: Verify Environment Variables
Ensure these are set in Railway Variables:
- âœ… `DATABASE_URL` (auto-generated by Postgres plugin)
- âœ… `NEXTAUTH_URL` (your Railway app URL)
- âœ… `NEXTAUTH_SECRET` (generate with `openssl rand -base64 32`)
- âœ… Twilio credentials (if using SMS)
- âœ… SendGrid credentials (if using email)

### Step 3: Deploy
```bash
# From your local machine
git add .
git commit -m "feat: enterprise audit logging with request context"
git push origin main
```

Railway will automatically:
1. Build your app
2. Run `prisma db push --accept-data-loss` (syncs schema)
3. Start the server with `node .next/standalone/server.js`

---

## Verification Steps

### 1. Check Deployment Logs
```bash
railway logs --follow
```

Look for:
- âœ… `Prisma schema loaded`
- âœ… `Your database is now in sync`
- âœ… Server started successfully

### 2. Test Audit Logging
1. Visit your Railway app
2. Perform an action (e.g., create a contact group)
3. Check the `audit_logs` table in Railway's database browser

Expected fields populated:
- âœ… `action`, `resource`, `resourceId`
- âœ… `userId`, `ipAddress`, `userAgent`
- âœ… `requestId`, `method`, `path`
- âœ… `metadata` (action-specific data)
- âœ… `createdAt`

### 3. Test Request ID Propagation
```bash
curl -i https://your-app.railway.app/api/health
```

Response headers should include:
```
x-request-id: <uuid>
x-method: GET
x-path: /api/health
```

---

## Current Status

### âœ… Completed
- [x] Unified `logAudit()` implementation
- [x] Request context middleware
- [x] Database schema extended
- [x] All API routes migrated
- [x] Railway start script configured
- [x] Local testing passed

### ğŸ”„ Pending (You need to do)
- [ ] Configure Railway start command
- [ ] Deploy to Railway
- [ ] Verify audit logs in production

### ğŸ“‹ Future Enhancements (Phase 2)
- [ ] Typed taxonomy (Action/Resource enums)
- [ ] ESLint rule to forbid direct `prisma.auditLog.create()`
- [ ] Coverage expansion (auth failures, OTP, feature flags)
- [ ] S3 export for long-term retention
- [ ] Tamper-evidence (hash chain)
- [ ] UI for audit log viewing with filters

---

## Troubleshooting

### Issue: TypeScript error on `requestId`
**Cause**: Prisma Client not regenerated after schema change  
**Fix**: Run `pnpm prisma generate`

### Issue: Railway deployment fails with Prisma error
**Cause**: Start command not configured  
**Fix**: Set start command to `pnpm run start:railway` in Railway settings

### Issue: Audit logs missing `requestId`
**Cause**: Middleware not running or headers not propagating  
**Fix**: Verify `middleware.ts` is at repo root and exports default function

### Issue: Database schema out of sync
**Cause**: `prisma db push` not running on deploy  
**Fix**: Verify `start:railway` script in `package.json` and Railway start command

---

## Support

- **Documentation**: See `RAILWAY_DEPLOYMENT.md` for full deployment guide
- **Schema**: See `prisma/schema.prisma` for `AuditLog` model
- **Logger**: See `lib/rbac.ts` for `logAudit()` implementation
- **Middleware**: See `middleware.ts` for request context injection

---

## Summary

You now have enterprise-grade audit logging with:
- ğŸ” Full request tracing via `requestId`
- ğŸ“Š Comprehensive context capture (IP, UA, method, path)
- ğŸ” Consistent logging across all routes
- ğŸš€ Automatic schema sync on Railway deployments
- ğŸ“ˆ Performance-optimized with strategic indexes

**Next step**: Configure Railway start command and deploy! ğŸ‰
