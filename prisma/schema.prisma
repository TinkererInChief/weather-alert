generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
  engineType    = "binary"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id              String        @id @default(cuid())
  name            String?
  email           String?       @unique
  phone           String?       @unique
  emailVerified   DateTime?     @db.Timestamptz(6)
  image           String?
  role            String        @default("VIEWER")
  organizationId  String?
  isActive        Boolean       @default(true)
  lastLoginAt     DateTime?     @db.Timestamptz(6)
  approvalStatus  String        @default("pending")
  approvedBy      String?
  approvedAt      DateTime?     @db.Timestamptz(6)
  rejectionReason String?
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime      @updatedAt @db.Timestamptz(6)
  accounts        Account[]
  sessions        Session[]
  organization    Organization? @relation(fields: [organizationId], references: [id])
  auditLogs       AuditLog[]

  @@map("users")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @db.Timestamptz(6)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @db.Timestamptz(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model SmsOtp {
  id         String    @id @default(cuid())
  phone      String
  tokenHash  String
  expires    DateTime  @db.Timestamptz(6)
  attempts   Int       @default(0)
  createdAt  DateTime  @default(now()) @db.Timestamptz(6)
  consumedAt DateTime? @db.Timestamptz(6)

  @@index([phone])
  @@map("sms_otps")
}

enum ContactRole {
  EMERGENCY_COORDINATOR
  FIRST_RESPONDER
  CAPTAIN
  CHIEF_OFFICER
  ENGINEERING_OFFICER
  CREW_MEMBER
  PORT_AUTHORITY
  COAST_GUARD
  FLEET_MANAGER
  VESSEL_OWNER
  OPERATIONS_MANAGER
  SAFETY_OFFICER
  MARINE_SURVEYOR
  AGENT
  OTHER
}

model Contact {
  id                   String               @id @default(cuid())
  name                 String
  email                String?
  phone                String?              @unique
  whatsapp             String?
  location             String?
  role                 ContactRole?
  language             String               @default("en")
  timezone             String               @default("UTC")
  elevationMeters      Float?
  isCoastalResident    Boolean              @default(false)
  notificationChannels Json                 @default("[]")
  notificationSettings Json                 @default("{}")
  active               Boolean              @default(true)
  createdAt            DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime             @updatedAt @db.Timestamptz(6)
  groupMemberships     ContactGroupMember[]
  deliveryLogs         DeliveryLog[]
  vesselAssignments    VesselContact[]

  @@map("contacts")
}

model ContactGroup {
  id          String               @id @default(cuid())
  name        String
  description String?
  metadata    Json                 @default("{}")
  active      Boolean              @default(true)
  createdAt   DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime             @updatedAt @db.Timestamptz(6)
  members     ContactGroupMember[]

  @@map("contact_groups")
}

model ContactGroupMember {
  contactId String
  groupId   String
  contact   Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  group     ContactGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([contactId, groupId])
  @@map("contact_group_members")
}

model AlertZone {
  id        String   @id @default(cuid())
  name      String
  type      String
  zoneCode  String?  @unique
  priority  Int      @default(1)
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@map("alert_zones")
}

model EarthquakeEvent {
  id              String         @id @default(cuid())
  sourceId        String         @unique
  source          String
  magnitude       Float
  depth           Float?
  latitude        Float
  longitude       Float
  location        String
  occurredAt      DateTime       @db.Timestamptz(6)
  tsunamiPossible Boolean        @default(false)
  rawData         Json           @default("{}")
  status          String         @default("active")
  processed       Boolean        @default(false)
  createdAt       DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime       @updatedAt @db.Timestamptz(6)
  tsunamiAlerts   TsunamiAlert[]
  alertJobs       AlertJob[]

  @@map("earthquake_events")
}

model TsunamiAlert {
  id                   String           @id @default(cuid())
  eventId              String
  source               String
  alertType            String
  severityLevel        Int
  estimatedWaveHeight  Float?
  estimatedArrivalTime DateTime?        @db.Timestamptz(6)
  affectedZones        String[]         @default([])
  sourceEarthquakeId   String?
  cancellationTime     DateTime?        @db.Timestamptz(6)
  rawData              Json             @default("{}")
  createdAt            DateTime         @default(now()) @db.Timestamptz(6)
  sourceEarthquake     EarthquakeEvent? @relation(fields: [sourceEarthquakeId], references: [id])
  alertJobs            AlertJob[]

  @@map("tsunami_alerts")
}

model MessageTemplate {
  id        String   @id @default(cuid())
  name      String
  type      String
  channel   String
  language  String   @default("en")
  subject   String?
  content   String
  variables Json     @default("[]")
  version   Int      @default(1)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([name, channel, language, version])
  @@map("message_templates")
}

model AlertJob {
  id                String           @id @default(cuid())
  type              String
  eventType         String
  earthquakeEventId String?
  tsunamiAlertId    String?
  severity          Int
  priority          Int              @default(1)
  targetingSnapshot Json
  status            String           @default("pending")
  scheduledFor      DateTime         @default(now()) @db.Timestamptz(6)
  startedAt         DateTime?        @db.Timestamptz(6)
  completedAt       DateTime?        @db.Timestamptz(6)
  errorMessage      String?
  metadata          Json             @default("{}")
  createdAt         DateTime         @default(now()) @db.Timestamptz(6)
  earthquakeEvent   EarthquakeEvent? @relation(fields: [earthquakeEventId], references: [id])
  tsunamiAlert      TsunamiAlert?    @relation(fields: [tsunamiAlertId], references: [id])
  deliveryLogs      DeliveryLog[]

  @@map("alert_jobs")
}

model DeliveryLog {
  id                String    @id @default(cuid())
  alertJobId        String?   // Optional: for global alerts
  vesselAlertId     String?   // Optional: for vessel-specific alerts
  contactId         String
  channel           String
  provider          String?
  status            String
  attempts          Int       @default(0)
  providerMessageId String?
  errorMessage      String?   @db.Text
  sentAt            DateTime? @db.Timestamptz(6)
  deliveredAt       DateTime? @db.Timestamptz(6)
  readAt            DateTime? @db.Timestamptz(6)
  lastAttemptAt     DateTime? @db.Timestamptz(6)
  metadata          Json      @default("{}")
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @db.Timestamptz(6)
  
  alertJob          AlertJob?     @relation(fields: [alertJobId], references: [id], onDelete: Cascade)
  vesselAlert       VesselAlert?  @relation(fields: [vesselAlertId], references: [id], onDelete: Cascade)
  contact           Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([alertJobId])
  @@index([vesselAlertId])
  @@index([contactId])
  @@index([status])
  @@index([channel])
  @@map("delivery_logs")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  isActive    Boolean  @default(true)
  settings    Json     @default("{}")
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
  users       User[]

  @@map("organizations")
}

model AuditLog {
  id             String   @id @default(cuid())
  userId         String?
  action         String
  resource       String
  resourceId     String?
  metadata       Json     @default("{}")
  ipAddress      String?
  userAgent      String?
  eventId        String?  @unique @default(uuid())
  organizationId String?
  actorRole      String?
  actorEmail     String?
  sessionId      String?
  requestId      String?
  traceId        String?
  service        String?
  env            String?
  version        Int?
  method         String?
  path           String?
  httpStatus     Int?
  success        Boolean?
  severity       String?
  category       String?
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  user           User?    @relation(fields: [userId], references: [id])

  @@index([action, createdAt])
  @@index([resource, resourceId])
  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
  @@index([requestId])
  @@map("audit_logs")
}

model AlertLog {
  id               String   @id @default(cuid())
  earthquakeId     String
  magnitude        Float
  location         String
  latitude         Float?
  longitude        Float?
  depth            Float?
  timestamp        DateTime @default(now()) @db.Timestamptz(6)
  contactsNotified Int      @default(0)
  success          Boolean  @default(false)
  errorMessage     String?
  dataSources      String[] @default([])
  primarySource    String?
  sourceMetadata   Json?    @default("{}")
  createdAt        DateTime @default(now()) @db.Timestamptz(6)

  @@map("alert_logs")
}

model EarthquakeCache {
  id           String   @id @default(cuid())
  earthquakeId String   @unique
  magnitude    Float
  location     String
  latitude     Float?
  longitude    Float?
  depth        Float?
  timestamp    DateTime @db.Timestamptz(6)
  processed    Boolean  @default(false)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  @@map("earthquake_cache")
}

model VoiceCall {
  id          String    @id @default(cuid())
  callSid     String    @unique
  phoneNumber String
  alertType   String
  status      String
  duration    Int?
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  completedAt DateTime? @db.Timestamptz(6)

  @@map("voice_calls")
}

model BulkCallJob {
  id              String   @id @default(cuid())
  alertType       String
  totalContacts   Int
  successfulCalls Int
  failedCalls     Int
  customMessage   String?
  createdAt       DateTime @default(now()) @db.Timestamptz(6)

  @@map("bulk_call_jobs")
}

model SystemSettings {
  id        String   @id @default("global")
  settings  Json     @default("{}")
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
  updatedBy String?

  @@map("system_settings")
}

model HealthSnapshot {
  id        String        @id @default(cuid())
  service   HealthService
  status    HealthStatus
  latencyMs Int?
  error     String?
  createdAt DateTime      @default(now()) @db.Timestamptz(6)

  @@index([service, createdAt])
  @@map("health_snapshots")
}

model HealthEvent {
  id        String          @id @default(cuid())
  service   HealthService?
  eventType HealthEventType
  severity  HealthStatus    @default(warning)
  message   String
  oldStatus HealthStatus?
  newStatus HealthStatus?
  metadata  Json            @default("{}")
  createdAt DateTime        @default(now()) @db.Timestamptz(6)

  @@index([createdAt])
  @@index([service, createdAt])
  @@map("health_events")
}

model MaintenanceWindow {
  id               String   @id @default(cuid())
  title            String
  description      String?
  startTime        DateTime @db.Timestamptz(6)
  endTime          DateTime @db.Timestamptz(6)
  affectedServices String[] @default([])
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)

  @@index([startTime, endTime])
  @@map("maintenance_windows")
}

model GlobalVessel {
  id                 String              @id @default(cuid())
  imo                String              @unique
  mmsi               String?             @unique
  name               String
  callsign           String?
  vesselType         String
  vesselTypeDetailed String?
  flag               String?
  length             Float?
  width              Float?
  height             Float?
  grossTonnage       Float?
  deadweight         Float?
  netTonnage         Float?
  buildYear          Int?
  builder            String?
  owner              String?
  operator           String?
  manager            String?
  technicalManager   String?
  classification     String?
  classNumber        String?
  portOfRegistry     String?
  hullNumber         String?
  status             String              @default("active")
  
  // Enrichment metadata
  dataSource         String[]            @default([])
  lastVerified       DateTime            @db.Timestamptz(6)
  dataQuality        Int                 @default(50)
  verifiedBy         String?
  
  // Search optimization
  searchText         String?
  
  // Relations
  trackedVesselId    String?             @unique @map("tracked_vessel_id")
  trackedVessel      Vessel?             @relation(fields: [trackedVesselId], references: [id])
  fleetAssignments   GlobalFleetVessel[]
  
  createdAt          DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @db.Timestamptz(6)
  
  @@index([imo])
  @@index([mmsi])
  @@index([name])
  @@index([vesselType])
  @@index([flag])
  @@index([status])
  @@index([searchText])
  @@map("global_vessels")
}

model Vessel {
  id                String           @id @default(cuid())
  mmsi              String           @unique
  imo               String?          @unique
  name              String
  callsign          String?
  vesselType        String
  flag              String?
  length            Float?
  width             Float?
  height            Float?
  draught           Float?
  grossTonnage      Float?
  operator          String?
  owner             String?
  active            Boolean          @default(true)
  lastSeen          DateTime?        @db.Timestamptz(6)
  createdAt         DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime         @updatedAt @db.Timestamptz(6)
  buildYear         Int?             @map("build_year")
  manager           String?
  enrichedAt        DateTime?        @map("enriched_at") @db.Timestamptz(6)
  enrichmentSource  String?          @map("enrichment_source")
  positions         VesselPosition[]
  alerts            VesselAlert[]
  contacts          VesselContact[]
  fleetVessels      FleetVessel[]
  globalVessel      GlobalVessel?

  @@index([mmsi])
  @@index([active])
  @@index([vesselType])
  @@map("vessels")
}

model VesselPosition {
  id                String    @default(cuid())
  vesselId          String
  latitude          Float
  longitude         Float
  speed             Float?
  course            Float?
  heading           Float?
  navStatus         String?
  destination       String?
  eta               DateTime? @db.Timestamptz(6)
  draught           Float?
  captain           String?
  timestamp         DateTime  @db.Timestamptz(6)
  dataSource        String    @default("marinetraffic")
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  rateOfTurn        Float?    @map("rate_of_turn")
  positionAccuracy  Boolean?  @map("position_accuracy")
  vessel            Vessel    @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@id([id, timestamp])
  @@index([vesselId, timestamp])
  @@index([timestamp])
  @@map("vessel_positions")
}

model VesselAlert {
  id             String    @id @default(cuid())
  vesselId       String
  type           String
  severity       String
  eventId        String?
  eventType      String?
  riskLevel      String
  tsunamiETA     Int?
  waveHeight     Float?
  waterDepth     Float?
  distance       Float?
  recommendation String
  actions        String[]  @default([])
  aiContext      String?
  
  // Auto-alert fields
  message        String?   @db.Text  // The actual alert message text
  coordinates    Json?     // Event location: {lat, lon}
  status         String    @default("pending")  // "pending" | "sent" | "acknowledged" | "expired"
  sentAt         DateTime? @db.Timestamptz(6)
  expiresAt      DateTime? @db.Timestamptz(6)
  
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime? @db.Timestamptz(6)
  acknowledgedBy String?
  resolvedAt     DateTime? @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @db.Timestamptz(6)
  
  vessel         Vessel       @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  deliveryLogs   DeliveryLog[]

  @@index([vesselId, createdAt])
  @@index([type, severity])
  @@index([riskLevel])
  @@index([status])
  @@index([eventId])
  @@map("vessel_alerts")
}

enum VesselContactRole {
  OWNER
  OPERATOR
  MANAGER
  CAPTAIN
  CHIEF_OFFICER
  CHIEF_ENGINEER
  CREW
  AGENT
  EMERGENCY_CONTACT
  TECHNICAL_SUPPORT
  OTHER
}

model VesselContact {
  id        String             @id @default(cuid())
  vesselId  String
  contactId String
  role      VesselContactRole  @default(CREW)
  primary   Boolean            @default(false)
  priority  Int                @default(1)  // 1 = highest priority
  notifyOn  String[]           @default(["critical", "high"])  // Alert levels to notify
  createdAt DateTime           @default(now()) @db.Timestamptz(6)
  vessel    Vessel             @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  contact   Contact            @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([vesselId, contactId])
  @@index([vesselId])
  @@index([contactId])
  @@index([priority])
  @@map("vessel_contacts")
}

model Fleet {
  id            String              @id @default(cuid())
  name          String
  description   String?
  ownerId       String              @map("owner_id")
  metadata      Json                @default("{}")
  active        Boolean             @default(true)
  createdAt     DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  vessels       FleetVessel[]
  globalVessels GlobalFleetVessel[]

  @@index([ownerId])
  @@index([active])
  @@map("fleets")
}

model FleetVessel {
  id        String   @id @default(cuid())
  fleetId   String   @map("fleet_id")
  vesselId  String   @map("vessel_id")
  role      String   @default("primary")  // "primary", "backup", "auxiliary"
  priority  Int      @default(1)          // 1 = highest priority
  metadata  Json     @default("{}")
  addedAt   DateTime @default(now()) @map("added_at") @db.Timestamptz(6)
  fleet     Fleet    @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  vessel    Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@unique([fleetId, vesselId])
  @@index([fleetId])
  @@index([vesselId])
  @@map("fleet_vessels")
}

model GlobalFleetVessel {
  id              String       @id @default(cuid())
  fleetId         String       @map("fleet_id")
  globalVesselId  String       @map("global_vessel_id")
  role            String       @default("primary")  // "primary", "backup", "auxiliary"
  priority        Int          @default(1)          // 1 = highest priority
  metadata        Json         @default("{}")
  addedAt         DateTime     @default(now()) @map("added_at") @db.Timestamptz(6)
  fleet           Fleet        @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  globalVessel    GlobalVessel @relation(fields: [globalVesselId], references: [id], onDelete: Cascade)

  @@unique([fleetId, globalVesselId])
  @@index([fleetId])
  @@index([globalVesselId])
  @@map("global_fleet_vessels")
}

model Port {
  id            String   @id @default(cuid())
  
  // Identification
  portName      String
  alternateNames String? // Comma-separated alternate names
  unLocode      String?  @unique // UN/LOCODE (e.g., USNYC)
  worldPortIndex String? // WPI Index Number
  country       String
  countryCode   String?  // ISO 2-letter code
  region        String?
  
  // Location
  latitude      Float
  longitude     Float
  
  // Characteristics
  harborSize    String?  // Small, Medium, Large, Very Large
  harborType    String?  // Coastal Natural, Coastal Breakwater, River, Lake, etc.
  shelter       String?  // Good, Fair, Poor, None
  
  // Entry Restrictions
  entryRestrictions String? // Tide, Ice, Swell, etc.
  overhead      String?  // Overhead limitations
  channel       String?  // Channel depth
  anchorage     String?  // Anchorage available
  
  // Cargo Handling
  cargoPier     Boolean  @default(false)
  cargoBeach    Boolean  @default(false)
  cargoIce      Boolean  @default(false)
  medMoor       Boolean  @default(false) // Mediterranean mooring
  
  // Facilities & Services
  hasFuel       Boolean  @default(false)
  hasRepair     Boolean  @default(false)
  hasDrydock    Boolean  @default(false)
  hasRailway    Boolean  @default(false)
  hasSupplies   Boolean  @default(false)
  hasMedical    Boolean  @default(false)
  hasGarbage    Boolean  @default(false)
  hasTugAssist  Boolean  @default(false)
  hasPilotage   Boolean  @default(false)
  
  // Vessel Size Limits
  maxVesselSize String?  // Maximum vessel LOA
  maxVesselDraft Float?  // Maximum draft in meters
  maxVesselBeam Float?   // Maximum beam in meters
  
  // Tides
  meanTideRange Float?   // Mean tide range in meters
  maxTideRange  Float?   // Maximum tide range in meters
  
  // Contact
  portAuthority String?
  telephone     String?
  email         String?
  website       String?
  
  // Metadata
  dataSource    String   @default("manual") // nga, upply, manual
  dataQuality   Int      @default(0)
  searchText    String?  // For full-text search
  
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([unLocode])
  @@index([country])
  @@index([countryCode])
  @@index([latitude, longitude])
  @@index([portName])
  @@map("ports")
}

model RealtimeStats {
  id                      String   @id @default("singleton")
  positionsLastHour       Int      @default(0) @map("positions_last_hour")
  positionsLast15Min      Int      @default(0) @map("positions_last_15min")
  vesselsActiveLastHour   Int      @default(0) @map("vessels_active_last_hour")
  totalVessels            Int      @default(0) @map("total_vessels")
  totalPositionsEstimate  BigInt   @default(0) @map("total_positions_estimate")
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("realtime_stats")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum HealthService {
  database
  redis
  sms
  email
  usgs
  noaa
  emsc
  jma
  ptwc
  iris
  whatsapp
  voice
}

enum HealthStatus {
  healthy
  warning
  critical
}

enum HealthEventType {
  status_change
  error
  recovery
  deploy
}
